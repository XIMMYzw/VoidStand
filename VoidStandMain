local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer
local Active = true
getgenv().Whitelist = {}
getgenv().Teamed = {} -- Teamed players (protected + sentry protection)
getgenv().LastDance = nil
getgenv().FORCE_STOP_ORBIT = false
getgenv().LOOP_KILL_ACTIVE = false
getgenv().LOOP_STOMP_KILL_ACTIVE = false
getgenv().BUYING_AMMO = false
getgenv().BUYING_LOCK = false -- Mutex lock to prevent concurrent buying
getgenv().FORCED_TARGETS = {}
getgenv().NO_RELOAD = false
getgenv().NO_RELOAD_STOMP = false
getgenv().NO_RELOAD_GRAB = false
getgenv().NO_RELOAD_BUYING = false
getgenv().ABOUT_TO_STOMP = false
getgenv().ABOUT_TO_GRAB = false
getgenv().KA_ACTIVE = false
getgenv().KA_SPEAKER = nil
getgenv().CURRENT_LOOP_TARGETS = {}
getgenv().CURRENT_LOOP_CMD = nil

if LocalPlayer and LocalPlayer.Name == tostring(getgenv().Owner) then
    print("u executed on wrong acc we didnt execute it:3")
    return
end

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local function stopfakeposrespawn()
    local duration = 1
    local startTime = tick()
    local hbConn

    hbConn = RunService.Heartbeat:Connect(function()
        if tick() - startTime > duration then
            if hbConn and hbConn.Disconnect then
                pcall(function() hbConn:Disconnect() end)
            end
            return
        end

        local char = LocalPlayer.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        if hum and hum.Health > 0 then
            hum.Health = 0
        end
    end)

    local char = LocalPlayer.Character
    if char and char:FindFirstChildOfClass("Humanoid") then
        char:BreakJoints()
    end

    LocalPlayer.CharacterAdded:Connect(function(char)
        local hum = char:WaitForChild("Humanoid", 5)
        if hum then
            hum.Died:Connect(function() end)
        end
    end)

    print("Meow made by @l22ux")
end

-- Simple Anti-Stomp: Reset health to 0 when health is 17 or lower
task.spawn(function()
    while task.wait(0.1) do
        if not getgenv().Settings.AntiStomp.Mode then
            continue
        end

        local char = LocalPlayer.Character
        if not char then
            continue
        end

        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if humanoid and humanoid.Health > 0 and humanoid.Health <= 17 then
            humanoid.Health = 0
        end
    end
end)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local recentlyEquipped = {}

task.spawn(function()
    while task.wait(0.1) do
        for _, plr in ipairs(Players:GetPlayers()) do
            local char = plr.Character
            if char then
                local hasTool = char:FindFirstChildOfClass("Tool") ~= nil
                if hasTool then
                    recentlyEquipped[plr.Name] = tick()
                end
            end
        end
        
        for name, t in pairs(recentlyEquipped) do
            if tick() - t > 3 then
                recentlyEquipped[name] = nil
            end
        end
    end
end)

local function hadToolRecently(plr)
    local t = recentlyEquipped[plr.Name]
    return t and (tick() - t <= 3)
end

local function findShooterFromBulletObject(bulletObj, speakerChar)
    for _, v in ipairs(bulletObj:GetChildren()) do
        if v:IsA("StringValue") or v:IsA("ObjectValue") then
            local name = v.Name:lower()
            if name:match("owner") or name:match("creator") or name:match("shooter") or name:match("player") then
                local candidate = v.Value
                if typeof(candidate) == "Instance" then
                    local pl = Players:GetPlayerFromCharacter(candidate)
                    if pl then return pl end
                    if candidate:IsA("Player") then return candidate end
                elseif type(candidate) == "string" then
                    local pl = Players:FindFirstChild(candidate)
                    if pl then return pl end
                end
            end
        end
    end

    local anc = bulletObj.Parent
    while anc do
        local pl = Players:GetPlayerFromCharacter(anc)
        if pl then return pl end
        anc = anc.Parent
    end

    local originPos
    if bulletObj:IsA("BasePart") then
        originPos = bulletObj.Position
    else
        local bp = bulletObj:FindFirstChildWhichIsA("BasePart") or bulletObj:FindFirstChildWhichIsA("Attachment")
        if bp then
            if bp:IsA("Attachment") then
                originPos = bp.WorldPosition
            else
                originPos = bp.Position
            end
        end
    end

    if originPos then
        local bestPl, bestDist = nil, math.huge
        for _, p in ipairs(Players:GetPlayers()) do
            local c = p.Character
            if c then
                local tool = c:FindFirstChildOfClass("Tool")
                if tool and tool:FindFirstChild("Handle") then
                    local d = (tool.Handle.Position - originPos).Magnitude
                    if d < 50 and d < bestDist then
                        bestPl, bestDist = p, d
                    end
                end
                local hrp = c:FindFirstChild("HumanoidRootPart")
                if hrp then
                    local d2 = (hrp.Position - originPos).Magnitude
                    if d2 < 25 and d2 < bestDist then
                        bestPl, bestDist = p, d2
                    end
                end
            end
        end
        if bestPl then return bestPl end
    end

    return nil
end

local function sendChat(msg)
    local ok, channel = pcall(function()
        return TextChatService.TextChannels and TextChatService.TextChannels:FindFirstChild("RBXGeneral")
    end)
    if ok and channel then
        pcall(function() channel:SendAsync(tostring(msg)) end)
    end
end

local ok, MainEvent = pcall(function()
	return ReplicatedStorage:WaitForChild("MainEvent", 2)
end)
if not ok or not MainEvent then
	MainEvent = nil
end

local gunMapping = {
	['rifle'] = '[Rifle]',
	['flintlock'] = '[Flintlock]',
	['aug'] = '[AUG]',
	['lmg'] = '[LMG]',
	['double'] = '[Double-Barrel SG]',
    ['silencerar'] = '[SilencerAR]',
    ['tac'] = '[TacticalShotgun]',
}

local ammoMapping = {
	['rifle'] = '5 [Rifle Ammo]',
	['flintlock'] = '6 [Flintlock Ammo]',
	['aug'] = '90 [AUG Ammo]',
	['lmg'] = '200 [LMG Ammo]',
	['double'] = '18 [Double-Barrel SG Ammo]',
    ['silencerar'] = '120 [SilencerAR Ammo]',
    ['tac'] = '20 [TacticalShotgun Ammo]',
}

local function hasAccess(plr)
	return plr and (plr.Name == tostring(getgenv().Owner) or getgenv().Whitelist[plr.Name])
end

local function stopActivePose()
	if getgenv().ActiveAnim and typeof(getgenv().ActiveAnim) == "Instance" then
		pcall(function()
			getgenv().ActiveAnim:Stop()
			getgenv().ActiveAnim:Destroy()
		end)
		getgenv().ActiveAnim = nil
	end
end

local function playDance(animationId)
    if not animationId then return end
    animationId = tostring(animationId)

    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    if not char then return end

    local humanoid = char:FindFirstChildOfClass('Humanoid') or char:WaitForChild("Humanoid", 5)
    if not humanoid then return end

    local animator = humanoid:FindFirstChildOfClass('Animator')
    if not animator then
        animator = Instance.new('Animator')
        animator.Parent = humanoid
    end

    stopActivePose()

    local ok, err = pcall(function()
        local anim = Instance.new('Animation')
        anim.AnimationId = 'rbxassetid://' .. animationId
        local track = animator:LoadAnimation(anim)
        track.Priority = Enum.AnimationPriority.Action
        track.Looped = true
        track:Play()
        getgenv().ActiveAnim = track
        getgenv().LastDance = animationId
    end)
    if not ok then
        warn("[playDance] failed to play animation:", animationId, err)
    end
end

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(0.001)
    if getgenv().LastDance then
        pcall(playDance, getgenv().LastDance)
    end
end)

local function HasGunByName(gunKey)
	if not LocalPlayer then return false end
	gunKey = string.lower(string.gsub(gunKey, '%s+', ''))
	local backpack = LocalPlayer:FindFirstChild("Backpack")
	if backpack then
		for _, item in pairs(backpack:GetChildren()) do
			if string.find(string.lower(item.Name), gunKey) then return true end
		end
	end
	if LocalPlayer.Character then
		for _, item in pairs(LocalPlayer.Character:GetChildren()) do
			if string.find(string.lower(item.Name), gunKey) then return true end
		end
	end
	return false
end

-- Helper to check if bot is in combat
local function isInCombat()
	if killAuraEnabled then return true end
	if getgenv().KA_ACTIVE then return true end
	if getgenv().LOOP_KILL_ACTIVE then return true end
	if getgenv().LOOP_STOMP_KILL_ACTIVE then return true end
	if getgenv().ABOUT_TO_STOMP then return true end
	if getgenv().ABOUT_TO_GRAB then return true end
	if getgenv().orbiting then return true end
	-- Check if there are active forced targets
	if getgenv().FORCED_TARGETS and #getgenv().FORCED_TARGETS > 0 then return true end
	return false
end

-- Store combat state before buying
getgenv().COMBAT_PAUSED_FOR_BUY = false
getgenv().SAVED_COMBAT_STATE = {}

-- Helper to pause combat for buying
local function pauseCombatForBuying()
	if not isInCombat() then return end
	
	getgenv().COMBAT_PAUSED_FOR_BUY = true
	getgenv().SAVED_COMBAT_STATE = {
		killAuraEnabled = killAuraEnabled,
		KA_ACTIVE = getgenv().KA_ACTIVE,
		KA_SPEAKER = getgenv().KA_SPEAKER,
		LOOP_KILL_ACTIVE = getgenv().LOOP_KILL_ACTIVE,
		LOOP_STOMP_KILL_ACTIVE = getgenv().LOOP_STOMP_KILL_ACTIVE,
		FORCED_TARGETS = getgenv().FORCED_TARGETS,
		CURRENT_LOOP_TARGETS = getgenv().CURRENT_LOOP_TARGETS,
		CURRENT_LOOP_CMD = getgenv().CURRENT_LOOP_CMD,
		orbiting = getgenv().orbiting,
		orbitTarget = getgenv().orbitTarget,
	}
	
	-- Temporarily disable combat
	killAuraEnabled = false
	pcall(stopOrbit)
end

-- Helper to resume combat after buying
local function resumeCombatAfterBuying()
	if not getgenv().COMBAT_PAUSED_FOR_BUY then return end
	
	local state = getgenv().SAVED_COMBAT_STATE
	if not state then return end
	
	-- Restore combat state
	if state.killAuraEnabled then
		killAuraEnabled = true
	end
	if state.KA_ACTIVE then
		getgenv().KA_ACTIVE = true
		getgenv().KA_SPEAKER = state.KA_SPEAKER
	end
	if state.LOOP_KILL_ACTIVE then
		getgenv().LOOP_KILL_ACTIVE = true
	end
	if state.LOOP_STOMP_KILL_ACTIVE then
		getgenv().LOOP_STOMP_KILL_ACTIVE = true
	end
	if state.FORCED_TARGETS then
		getgenv().FORCED_TARGETS = state.FORCED_TARGETS
	end
	if state.CURRENT_LOOP_TARGETS then
		getgenv().CURRENT_LOOP_TARGETS = state.CURRENT_LOOP_TARGETS
	end
	if state.CURRENT_LOOP_CMD then
		getgenv().CURRENT_LOOP_CMD = state.CURRENT_LOOP_CMD
	end
	if state.orbiting and state.orbitTarget then
		pcall(function() startOrbit(state.orbitTarget) end)
	end
	
	getgenv().COMBAT_PAUSED_FOR_BUY = false
	getgenv().SAVED_COMBAT_STATE = {}
end

-- Helper to force unequip all tools
local function forceUnequipAllTools()
	local char = LocalPlayer.Character
	if not char then return end
	
	local humanoid = char:FindFirstChildOfClass("Humanoid")
	if humanoid then
		humanoid:UnequipTools()
	end
	
	-- Force move ALL tools to backpack
	for _, tool in pairs(char:GetChildren()) do
		if tool:IsA("Tool") then
			pcall(function() tool.Parent = LocalPlayer.Backpack end)
		end
	end
end

local function BuyItem(itemName, times)
	-- Wait for any existing buy operation to complete (mutex lock)
	local waitStart = tick()
	while getgenv().BUYING_LOCK and tick() - waitStart < 10 do
		task.wait(0.1)
	end
	
	-- Pause combat if in combat (will resume after buying)
	local wasInCombat = isInCombat()
	if wasInCombat then
		pauseCombatForBuying()
		task.wait(0.1)
	end
	
	-- Acquire lock
	getgenv().BUYING_LOCK = true
	getgenv().NO_RELOAD_BUYING = true
	getgenv().BUYING_AMMO = true
	
	-- STOP THE VOID - disconnect the heartbeat connection so it doesn't interfere
	local wasVoidEnabled = voidEnabled
	if voidConnection then
		pcall(function() voidConnection:Disconnect() end)
		voidConnection = nil
	end
	isRunning = false
	
	-- Quick unequip
	forceUnequipAllTools()
	task.wait(0.05)
	forceUnequipAllTools()
	task.wait(0.05)
	
	local RootPart = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
	if not RootPart then 
		getgenv().BUYING_LOCK = false
		getgenv().NO_RELOAD_BUYING = false
		getgenv().BUYING_AMMO = false
		-- Restart void if it was running
		if wasVoidEnabled and not killAuraEnabled then
			task.delay(0.1, startVoid)
		end
		return 
	end
	
	local success, ShopFolder = pcall(function()
		return workspace:WaitForChild("Ignored"):WaitForChild("Shop")
	end)
	if not success or not ShopFolder then 
		getgenv().BUYING_LOCK = false
		getgenv().NO_RELOAD_BUYING = false
		getgenv().BUYING_AMMO = false
		-- Restart void if it was running
		if wasVoidEnabled and not killAuraEnabled then
			task.delay(0.1, startVoid)
		end
		return 
	end

	local ItemModel
	for _, child in ipairs(ShopFolder:GetChildren()) do
		if string.sub(child.Name, 1, #itemName) == itemName then
			ItemModel = child
			break
		end
	end
	if not ItemModel then 
		getgenv().BUYING_LOCK = false
		getgenv().NO_RELOAD_BUYING = false
		getgenv().BUYING_AMMO = false
		-- Restart void if it was running
		if wasVoidEnabled and not killAuraEnabled then
			task.delay(0.1, startVoid)
		end
		return 
	end

	local ClickDetector = ItemModel:FindFirstChildOfClass("ClickDetector")
	if not ClickDetector then 
		getgenv().BUYING_LOCK = false
		getgenv().NO_RELOAD_BUYING = false
		getgenv().BUYING_AMMO = false
		-- Restart void if it was running
		if wasVoidEnabled and not killAuraEnabled then
			task.delay(0.1, startVoid)
		end
		return 
	end

	local targetPart = ItemModel:FindFirstChild("Head") or ItemModel.PrimaryPart or ItemModel:FindFirstChildWhichIsA("BasePart")
	if not targetPart then 
		getgenv().BUYING_LOCK = false
		getgenv().NO_RELOAD_BUYING = false
		getgenv().BUYING_AMMO = false
		-- Restart void if it was running
		if wasVoidEnabled and not killAuraEnabled then
			task.delay(0.1, startVoid)
		end
		return 
	end

	local OriginalCFrame = RootPart.CFrame
	
	-- Teleport UNDER the shop item (3.8 studs below)
	local targetCFrame = targetPart.CFrame * CFrame.new(0, -3.8, 0)
	
	-- Helper to freeze character in place (no anchoring)
	local function freezeCharacter()
		local char = LocalPlayer.Character
		if not char then return end
		RootPart.CFrame = targetCFrame
		RootPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
		RootPart.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
		for _, part in pairs(char:GetDescendants()) do
			if part:IsA("BasePart") then
				part.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
				part.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
			end
		end
	end
	
	for i = 1, times do
		-- Keep tools unequipped
		forceUnequipAllTools()
		
		-- FAST stabilize - teleport under shop and freeze continuously
		for stabilize = 1, 8 do
			freezeCharacter()
			task.wait()
			freezeCharacter()
		end
		
		-- Quick unequip check
		forceUnequipAllTools()
		
		-- FAST click - keep freezing while clicking
		for clickAttempt = 1, 2 do
			freezeCharacter()
			task.wait()
			freezeCharacter()
			pcall(fireclickdetector, ClickDetector)
			freezeCharacter()
			task.wait(0.05)
			freezeCharacter()
		end
		
		freezeCharacter()
		task.wait(0.05)
	end
	
	-- Return to original position
	RootPart.CFrame = OriginalCFrame
	task.wait(0.05)
	
	-- Release lock and clear flags
	getgenv().BUYING_LOCK = false
	getgenv().NO_RELOAD_BUYING = false
	getgenv().BUYING_AMMO = false
	
	-- Resume combat if it was paused
	if wasInCombat then
		task.delay(0.1, function()
			resumeCombatAfterBuying()
		end)
	-- Restart void if it was running before buying (and not resuming combat)
	elseif wasVoidEnabled then
		task.delay(0.2, function()
			if not getgenv().BUYING_LOCK and not isInCombat() then
				startVoid()
			end
		end)
	end
end

local function BuyGuns()
	local gunsList = getgenv().Settings and getgenv().Settings.Guns and getgenv().Settings.Guns.List
	if not gunsList then return end
	
	-- Check if we actually need to buy guns
	local needToBuy = false
	for _, gun in ipairs(gunsList) do
		local key = string.lower(string.gsub(gun, '%s+', ''))
		if not HasGunByName(key) then
			needToBuy = true
			break
		end
	end
	
	if not needToBuy then return end
	
	-- Buy guns ONE AT A TIME in order
	for _, gun in ipairs(gunsList) do
		local key = string.lower(string.gsub(gun, '%s+', ''))
		if not HasGunByName(key) then
			local gunName = gunMapping[key]
			if gunName then
				-- BuyItem handles its own locking and unequipping
				BuyItem(gunName, 1)
				task.wait(0.5) -- Wait between purchases
			end
		end
	end
	
	-- Re-equip after all purchases complete
	task.wait(0.3)
	pcall(AutoEquipGuns)
end

local function BuyAmmo()
	local gunsList = getgenv().Settings and getgenv().Settings.Guns and getgenv().Settings.Guns.List
	if not gunsList then return end
	
	-- Buy ammo ONE AT A TIME, only for guns we have
	for _, gun in ipairs(gunsList) do
		local key = string.lower(string.gsub(gun, '%s+', ''))
		
		-- IMPORTANT: Can only buy ammo if we have the gun
		if not HasGunByName(key) then
			continue -- Skip ammo for guns we don't have
		end
		
		local ammoName = ammoMapping[key]
		if ammoName then
			-- Buy ammo multiple times for this gun
			for i = 1, 5 do
				-- BuyItem handles its own locking and unequipping
				BuyItem(ammoName, 1)
				task.wait(0.5) -- Wait between purchases
			end
		end
	end
	
	-- Re-equip after all purchases
	task.wait(0.3)
	pcall(AutoEquipGuns)
end

local autoEquipLoop

local function AutoEquipGuns()
	-- Don't equip if buying ammo or guns (check ALL buying flags)
	if getgenv().BUYING_AMMO then return end
	if getgenv().BUYING_LOCK then return end
	if getgenv().NO_RELOAD_BUYING then return end
	
	local gunsList = getgenv().Settings and getgenv().Settings.Guns and getgenv().Settings.Guns.List
	if not gunsList then return end
	if not LocalPlayer.Character then return end
	
	for _, gunKey in ipairs(gunsList) do
		local key = string.lower(string.gsub(gunKey, '%s+', ''))
		local toolName = gunMapping[key]
		if toolName then
			local backpackTool = LocalPlayer.Backpack:FindFirstChild(toolName)
			local charTool = LocalPlayer.Character:FindFirstChild(toolName)
			local tool = backpackTool or charTool
			if tool and tool:IsA("Tool") and tool.Parent ~= LocalPlayer.Character then
				tool.Parent = LocalPlayer.Character
			end
		end
	end
end

function startAutoEquipGuns()
	if autoEquipLoop then return end 
	autoEquipLoop = true
	task.spawn(function()
		while autoEquipLoop do
			-- Check ALL buying flags before equipping
			if not getgenv().BUYING_AMMO and not getgenv().BUYING_LOCK and not getgenv().NO_RELOAD_BUYING then
				pcall(AutoEquipGuns)
			end
			task.wait(0.1) 
		end
	end)

	LocalPlayer.CharacterAdded:Connect(function()
		repeat task.wait() until LocalPlayer.Character
		task.wait(0.5) -- Wait a bit after respawn
		-- Check ALL buying flags before equipping
		if not getgenv().BUYING_AMMO and not getgenv().BUYING_LOCK and not getgenv().NO_RELOAD_BUYING then
			pcall(AutoEquipGuns)
		end
	end)
end

function stopAutoEquipGuns()
	autoEquipLoop = false
end

getgenv().orbiting = false
getgenv().orbitTarget = nil
getgenv().wasOrbitingBeforeArmor = false

-- Orbit state for smooth random movement
local orbitAngle = 0
local orbitHeight = 0
local orbitJitterX = 0
local orbitJitterZ = 0

local function getRandomPositionAroundTarget(targetRoot)
    if not targetRoot then return nil end

    -- Add random jitter to angle (fast, erratic movement)
    orbitAngle = orbitAngle + math.random(15, 45) + math.random() * 20
    if orbitAngle > 360 then orbitAngle = orbitAngle - 360 end
    
    -- Random height jitter
    orbitHeight = orbitHeight + math.random(-3, 3)
    orbitHeight = math.clamp(orbitHeight, -8, 15)
    
    -- Extra random jitter for unpredictable movement
    orbitJitterX = math.random(-5, 5) + math.random() * 3
    orbitJitterZ = math.random(-5, 5) + math.random() * 3
    
    -- Minimum 15 studs, max 25 studs distance (random each time)
    local distance = math.random(15, 25) + math.random() * 5

    local rad = math.rad(orbitAngle)
    local offsetX = math.cos(rad) * distance + orbitJitterX
    local offsetZ = math.sin(rad) * distance + orbitJitterZ
    local offset = Vector3.new(offsetX, orbitHeight, offsetZ)
    local pos = targetRoot.Position + offset

    return CFrame.new(pos)
end

-- Camera spectating function
local function updateBotCamera()
    local camera = workspace.CurrentCamera
    if not camera then return end
    
    local char = LocalPlayer.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hrp or not hum then return end
    
    -- If orbiting, spectate the orbit target from behind
    if getgenv().orbiting and getgenv().orbitTarget then
        local targetChar = getgenv().orbitTarget.Character
        local targetHRP = targetChar and targetChar:FindFirstChild("HumanoidRootPart")
        local targetHum = targetChar and targetChar:FindFirstChildOfClass("Humanoid")
        if targetHRP and targetHum then
            camera.CameraSubject = targetHum
            camera.CameraType = Enum.CameraType.Custom
            return
        end
    end
    
    -- Otherwise spectate self from behind
    camera.CameraSubject = hum
    camera.CameraType = Enum.CameraType.Custom
end

local function startOrbit(target)

    if getgenv().AURA_FORCE_DISABLE then
        return
    end

    if not (target and target.Character and target.Character:FindFirstChild("HumanoidRootPart")) then
        return
    end

    getgenv().orbiting = true
    getgenv().orbitTarget = target
    
    -- Reset orbit state for fresh random movement
    orbitAngle = math.random(0, 360)
    orbitHeight = math.random(-5, 10)

    task.spawn(function()
        while getgenv().orbiting and not getgenv().AURA_FORCE_DISABLE do
            task.wait() -- FASTER - every frame instead of 0.05

            local char = LocalPlayer.Character
            local myHRP = char and char:FindFirstChild("HumanoidRootPart")
            local targetRoot = target.Character and target.Character:FindFirstChild("HumanoidRootPart")

            if myHRP and targetRoot then
                myHRP.CFrame = getRandomPositionAroundTarget(targetRoot)
                updateBotCamera() -- Update camera while orbiting
            else
                break
            end
        end
    end)
end

local function stopOrbit()
    getgenv().orbiting = false
    getgenv().orbitTarget = nil
    -- Reset camera to self when stopping orbit
    task.delay(0.1, updateBotCamera)
end

-- Background camera update loop (when not orbiting)
task.spawn(function()
    while true do
        task.wait(0.5)
        if not getgenv().orbiting then
            pcall(updateBotCamera)
        end
    end
end)

local function findPlayerByNameOrPartial(str)
    if not str then return nil end
    str = str:lower()
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Name:lower():find(str) or p.DisplayName:lower():find(str) then return p end
    end
    return nil
end

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MainEvent

pcall(function()
    MainEvent = ReplicatedStorage:WaitForChild("MainEvent", 5)
end)

if not MainEvent then
    warn("[KillAura] MainEvent not found! Kill Aura won't work.")
end

local lastShotTimes = {}
local fireRate = 0.00001 

local function isProtectedPlayer(playerName)
    if not playerName then return false end
    if playerName == tostring(getgenv().Owner) then return true end
    if table.find(getgenv().Whitelist, playerName) then return true end
    if table.find(getgenv().Teamed, playerName) then return true end
    return false
end

local function canAuraAttack(enemy)
    if not enemy then return false end
    -- Check if this target was forced by owner command (k, sk, b, lk)
    if table.find(getgenv().FORCED_TARGETS, enemy.Name) then return true end
    if isProtectedPlayer(enemy.Name) then return false end
    return true
end

local function canCommandAttack(enemy, sender)
    if not enemy then return false end
    if not sender then return false end
    if sender.Name == tostring(getgenv().Owner) then return true end
    if isProtectedPlayer(enemy.Name) then return false end
    return true
end

local function validTargetForAura(enemy)
    if not (enemy and enemy.Character) then return false end
    if not canAuraAttack(enemy) then return false end
    if enemy.Character:FindFirstChildOfClass("ForceField") then return false end
    local bodyEffects = enemy.Character:FindFirstChild("BodyEffects")
    local isKO = bodyEffects and bodyEffects:FindFirstChild("K.O") and bodyEffects["K.O"].Value
    local isSDeath = bodyEffects and bodyEffects:FindFirstChild("SDeath") and bodyEffects["SDeath"].Value
    if isKO or isSDeath then return false end
    if not (enemy.Character:FindFirstChild("Head") and enemy.Character:FindFirstChild("HumanoidRootPart")) then return false end
    return true
end

local function shootAtTarget(tool, enemy)
    if not (tool and tool:FindFirstChild('Handle')) then return end
    if not validTargetForAura(enemy) then return end

    local head = enemy.Character:FindFirstChild('Head')
    local hrp = enemy.Character:FindFirstChild('HumanoidRootPart')
    if not (head and hrp) then return end

    local now = tick()
    if lastShotTimes[tool] and now - lastShotTimes[tool] < fireRate then return end
    lastShotTimes[tool] = now

    if MainEvent and typeof(MainEvent.FireServer) == "function" then
        pcall(function()
            MainEvent:FireServer(
                'ShootGun',
                tool.Handle,
                tool.Handle.Position,
                hrp.Position,
                head,
                Vector3.new(0,0,-1)
            )
        end)
    end
end

task.spawn(function()
    while true do
        task.wait(0.001)
        if killAuraEnabled and LocalPlayer.Character and #auraTargets > 0 then
            local copyTargets = {}
            for _, t in ipairs(auraTargets) do table.insert(copyTargets, t) end

            for _, enemy in ipairs(copyTargets) do
                if validTargetForAura(enemy) then
                    for _, tool in ipairs(LocalPlayer.Character:GetChildren()) do
                        if tool:IsA("Tool") and tool:FindFirstChild("Handle") then
                            shootAtTarget(tool, enemy)
                        end
                    end
                end
            end
        end
    end
end)

local function setAuraTargetsFromString(targetsStr)
    auraTargets = {}
    for name in targetsStr:gmatch("[^,]+") do
        local trimmed = name:match("^%s*(.-)%s*$")
        local pl = findPlayerByNameOrPartial(trimmed)
        if pl then
            if canAuraAttack(pl) then
                table.insert(auraTargets, pl)
            else
                sendChat("Protected: " .. pl.Name)
            end
        else
            sendChat("Invalid Target: " .. trimmed)
        end
    end
end

local function AutoReload()
    -- Check ALL reload prevention flags
    if getgenv().NO_RELOAD == true then return end
    if getgenv().NO_RELOAD_STOMP == true then return end
    if getgenv().NO_RELOAD_GRAB == true then return end
    if getgenv().NO_RELOAD_BUYING == true then return end
    if getgenv().ABOUT_TO_STOMP == true then return end
    if getgenv().ABOUT_TO_GRAB == true then return end
    if getgenv().BUYING_AMMO == true then return end
    if not LocalPlayer.Character or not MainEvent then return end
    for _, tool in ipairs(LocalPlayer.Character:GetChildren()) do
        if tool:IsA('Tool') then
            local ammo = tool:FindFirstChild('Ammo')
            if ammo and typeof(ammo.Value) == "number" and ammo.Value <= 1 then
                pcall(function() MainEvent:FireServer('Reload', tool) end)
                task.wait(0.25)
            end
        end
    end
end

task.spawn(function()
    while true do
        task.wait(0.2)
        if Active then AutoReload() end
    end
end)

-- Auto buy guns if missing
task.spawn(function()
    while true do
        task.wait(2)
        local gunsList = getgenv().Settings and getgenv().Settings.Guns and getgenv().Settings.Guns.List
        if gunsList and LocalPlayer.Character then
            for _, gun in ipairs(gunsList) do
                if not HasGunByName(gun) then
                    pcall(BuyGuns)
                    break
                end
            end
        end
    end
end)

-- Auto buy ammo when low (below 15)
local function getAmmoFromInventory(gunName)
    local dataFolder = LocalPlayer:FindFirstChild("DataFolder")
    if not dataFolder then return 999 end
    local inventory = dataFolder:FindFirstChild("Inventory")
    if not inventory then return 999 end
    local ammoValue = inventory:FindFirstChild(gunName)
    if ammoValue then
        return tonumber(ammoValue.Value) or 999
    end
    return 999
end

task.spawn(function()
    while true do
        task.wait(3)
        
        -- Skip if already buying
        if getgenv().BUYING_LOCK then
            continue
        end
        
        local gunsList = getgenv().Settings and getgenv().Settings.Guns and getgenv().Settings.Guns.List
        if gunsList and LocalPlayer.Character then
            -- Buy ammo ONE AT A TIME, only for guns we have
            -- BuyItem handles combat pause/resume internally
            for _, gun in ipairs(gunsList) do
                -- Skip if already buying
                if getgenv().BUYING_LOCK then
                    break
                end
                
                local key = string.lower(string.gsub(gun, '%s+', ''))
                
                -- IMPORTANT: Can only buy ammo if we have the gun
                if not HasGunByName(key) then
                    continue -- Skip ammo for guns we don't have
                end
                
                local gunName = gunMapping[key]
                if gunName then
                    local currentAmmo = getAmmoFromInventory(gunName)
                    -- Buy when ammo is 10 or lower, buy until 100 or more
                    if currentAmmo <= 10 then
                        local ammoName = ammoMapping[key]
                        if ammoName then
                            -- Keep buying until we have 100+ ammo
                            -- BuyItem will pause/resume combat as needed
                            while getAmmoFromInventory(gunName) < 100 do
                                BuyItem(ammoName, 1)
                                task.wait(0.3)
                            end
                        end
                    end
                end
            end
            
            -- Re-equip after buying
            task.wait(0.3)
            pcall(AutoEquipGuns)
        end
    end
end)

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

RunService.Stepped:Connect(function()
	local character = LocalPlayer.Character
	if character then
		for _, part in ipairs(character:GetDescendants()) do
			if part:IsA("BasePart") then
				part.CanCollide = false
			end
		end
	end
end)

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")

local voidConnection = nil
local rng = Random.new()
local respawnCooldown = false

local voidEnabled = false   
local isRunning = false     

getgenv().VoidSpeed = 0

local MIN_POS = -25000
local MAX_POS =  25000

local function forceCamera()
    local char = LocalPlayer.Character
    if not char then return end
    local hum = char:FindFirstChild("Humanoid")
    if hum then
        workspace.CurrentCamera.CameraSubject = hum
        workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
    end
end

function stopVoid()
    voidEnabled = false   
    isRunning = false     

    if voidConnection then
        voidConnection:Disconnect()
        voidConnection = nil
    end
end

function startVoid()
    voidEnabled = true   

    if isRunning or respawnCooldown then return end
    isRunning = true

    voidConnection = RunService.Heartbeat:Connect(function()
        if not voidEnabled then return end
        if not isRunning then return end
        
        -- STOP void teleporting if buying something
        if getgenv().BUYING_LOCK or getgenv().BUYING_AMMO or getgenv().NO_RELOAD_BUYING then
            return
        end

        local char = LocalPlayer.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if not char or not hrp then return end

        forceCamera()

        local x = rng:NextNumber(MIN_POS, MAX_POS)
        local y = rng:NextNumber(MIN_POS, MAX_POS)
        local z = rng:NextNumber(MIN_POS, MAX_POS)

        local cf = CFrame.new(x, y, z)

        hrp.AssemblyLinearVelocity = Vector3.zero
        hrp.AssemblyAngularVelocity = Vector3.zero

        hrp.CFrame = cf
        task.wait()
        hrp.CFrame = cf
        task.wait()
        hrp.CFrame = cf

        local delay = math.clamp(VoidSpeed, 0, 10)
        if delay > 0 then
            task.wait(delay)
        end
    end)
end

-- Background task to buy guns and ammo while in void/idle - runs frequently to stay ready
getgenv().VOID_RESUPPLY_RUNNING = true

task.spawn(function()
    while true do
        task.wait(1) -- Check every 1 second
        
        -- Skip if already buying
        if getgenv().BUYING_LOCK then
            continue
        end
        
        local LP = LocalPlayer
        if LP and LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
            
            local gunsList = getgenv().Settings and getgenv().Settings.Guns and getgenv().Settings.Guns.List
            if gunsList then
                -- Check if missing guns
                local needGuns = false
                for _, gun in ipairs(gunsList) do
                    if not HasGunByName(gun) then
                        needGuns = true
                        break
                    end
                end
                
                -- Buy guns FIRST if needed (before ammo)
                -- BuyItem handles combat pause/resume and void internally
                if needGuns and not getgenv().BUYING_LOCK then
                    pcall(BuyGuns)
                    task.wait(0.3)
                end
                
                -- Now check for ammo needs (only for guns we have)
                -- BuyItem handles combat pause/resume internally
                if not getgenv().BUYING_LOCK then
                    for _, gun in ipairs(gunsList) do
                        -- Skip if already buying
                        if getgenv().BUYING_LOCK then
                            break
                        end
                        
                        local key = string.lower(string.gsub(gun, '%s+', ''))
                        
                        -- IMPORTANT: Can only buy ammo if we have the gun
                        if not HasGunByName(key) then
                            continue
                        end
                        
                        local gunName = gunMapping[key]
                        if gunName then
                            local currentAmmo = getAmmoFromInventory(gunName)
                            -- Buy when ammo is 10 or lower, buy until 100 or more
                            if currentAmmo <= 10 then
                                local ammoName = ammoMapping[key]
                                if ammoName then
                                    -- Keep buying until we have 100+ ammo
                                    -- BuyItem will pause/resume combat as needed
                                    while getAmmoFromInventory(gunName) < 100 do
                                        BuyItem(ammoName, 1)
                                        task.wait(0.3)
                                    end
                                end
                            end
                        end
                    end
                    
                    task.wait(0.3)
                    pcall(AutoEquipGuns)
                end
            end
        end
    end
end)

-- Second background task - more aggressive resupply check
task.spawn(function()
    while true do
        task.wait(3)
        
        -- Skip if already buying
        if getgenv().BUYING_LOCK then
            continue
        end
        
        local LP = LocalPlayer
        if LP and LP.Character then
            local gunsList = getgenv().Settings and getgenv().Settings.Guns and getgenv().Settings.Guns.List
            if gunsList then
                -- Try to max out ammo (one at a time, only for guns we have)
                -- BuyItem handles combat pause/resume internally
                for _, gun in ipairs(gunsList) do
                    -- Skip if already buying
                    if getgenv().BUYING_LOCK then
                        break
                    end
                    
                    local key = string.lower(string.gsub(gun, '%s+', ''))
                    
                    -- IMPORTANT: Can only buy ammo if we have the gun
                    if not HasGunByName(key) then
                        continue
                    end
                    
                    local gunName = gunMapping[key]
                    if gunName then
                        local currentAmmo = getAmmoFromInventory(gunName)
                        -- Buy when ammo is 10 or lower, buy until 100 or more
                        if currentAmmo <= 10 then
                            local ammoName = ammoMapping[key]
                            if ammoName then
                                -- Keep buying until we have 100+ ammo
                                -- BuyItem will pause/resume combat as needed
                                while getAmmoFromInventory(gunName) < 100 do
                                    BuyItem(ammoName, 1)
                                    task.wait(0.3)
                                end
                            end
                            
                            -- Only buy one gun's ammo per cycle
                            break
                        end
                    end
                end
                
                task.wait(0.3)
                pcall(AutoEquipGuns)
            end
        end
    end
end)

function vanishBot()
    startVoid()
end

LocalPlayer.CharacterAdded:Connect(function()
    local wasVoidBefore = voidEnabled

    stopVoid()
    respawnCooldown = true
    task.wait(2)  
    respawnCooldown = false

    if wasVoidBefore then
        startVoid()
    end
end)


function teleportTo(plr)
    local char = LocalPlayer.Character
    if not char then return end

    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    if not plr or not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then return end
    local targetHRP = plr.Character.HumanoidRootPart

    stopVoid()

    local hum = char:FindFirstChild("Humanoid")
    if hum then
        workspace.CurrentCamera.CameraSubject = hum
        workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
    end
   hrp.AssemblyLinearVelocity = Vector3.zero
    hrp.AssemblyAngularVelocity = Vector3.zero

    for _, part in ipairs(char:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CanCollide = false
        end
    end

    local radius = math.random(4, 8)
    local angle = math.rad(math.random(0, 360))
    local offset = Vector3.new(math.cos(angle)*radius, 2, math.sin(angle)*radius)
    local tpPos = targetHRP.Position + offset

    local cf = CFrame.new(tpPos)

    hrp.CFrame = cf
    task.wait()
    hrp.CFrame = cf
    task.wait()
    hrp.CFrame = cf

    task.delay(0.25, function()
        for _, part in ipairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = true
            end
        end
    end)

    if voidEnabled then
        task.delay(0.3, function()
            startVoid()
        end)
    end
end

local successDF, dataFolder = pcall(function() return LocalPlayer:WaitForChild("DataFolder", 2) end)
local armorInfo = nil
if successDF and dataFolder then
    local successIF, infoFolder = pcall(function() return dataFolder:WaitForChild("Information", 2) end)
    if successIF and infoFolder then
        armorInfo = infoFolder:FindFirstChild("ArmorSave") or nil
    end
end

local armorShop = nil
local armorClickDetector = nil
pcall(function()
    armorShop = workspace:FindFirstChild("Ignored") and workspace.Ignored:FindFirstChild("Shop") and workspace.Ignored.Shop:FindFirstChild("[High-Medium Armor] - $2513")
    if armorShop then armorClickDetector = armorShop:FindFirstChild("ClickDetector") end
end)

local function canBuyArmor()
    local character = LocalPlayer.Character
    if not character then return false end

    local humanoid = character:FindFirstChild("Humanoid")
    if humanoid and humanoid.Health <= 1 then return false end

    local bodyEffects = character:FindFirstChild("BodyEffects")
    local isKO = bodyEffects and bodyEffects:FindFirstChild("K.O") and bodyEffects["K.O"].Value
    if isKO then return false end

    return true
end

local function teleportAndBuy(shop, clickDetector)
    local character = LocalPlayer.Character
    if not character or not character.PrimaryPart then return end

    -- Wait for any existing buy operation to complete (mutex lock)
    local waitStart = tick()
    while getgenv().BUYING_LOCK and tick() - waitStart < 10 do
        task.wait(0.1)
    end
    
    -- Pause combat if in combat (will resume after buying)
    local wasInCombat = isInCombat()
    if wasInCombat then
        pauseCombatForBuying()
        task.wait(0.1)
    end
    
    -- Acquire lock
    getgenv().BUYING_LOCK = true
    getgenv().NO_RELOAD_BUYING = true
    getgenv().BUYING_AMMO = true
    
    -- STOP THE VOID - disconnect the heartbeat connection so it doesn't interfere
    local wasVoidEnabled = voidEnabled
    if voidConnection then
        pcall(function() voidConnection:Disconnect() end)
        voidConnection = nil
    end
    isRunning = false
    
    -- Quick unequip
    forceUnequipAllTools()
    task.wait(0.05)
    forceUnequipAllTools()
    task.wait(0.05)

    local originalCFrame = character.PrimaryPart.CFrame
    local hrp = character.PrimaryPart

    if shop and shop:FindFirstChild("Head") then
        -- Teleport UNDER the shop item (3.8 studs below)
        local targetCFrame = shop.Head.CFrame * CFrame.new(0, -3.8, 0)
        
        -- Helper to freeze character in place (no anchoring)
        local function freezeChar()
            hrp.CFrame = targetCFrame
            hrp.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
            hrp.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
            for _, part in pairs(character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                    part.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
                end
            end
        end
        
        -- FAST stabilize - teleport under shop and freeze continuously
        for stabilize = 1, 8 do
            freezeChar()
            task.wait()
            freezeChar()
        end
        
        -- Quick unequip check
        forceUnequipAllTools()
        
        -- FAST click - keep freezing while clicking
        for clickAttempt = 1, 2 do
            freezeChar()
            task.wait()
            freezeChar()
            pcall(fireclickdetector, clickDetector)
            freezeChar()
            task.wait(0.05)
            freezeChar()
        end
        
        freezeChar()
        task.wait(0.05)
        hrp.CFrame = originalCFrame
    end
    
    task.wait(0.05)
    
    -- Release lock and clear flags
    getgenv().BUYING_LOCK = false
    getgenv().NO_RELOAD_BUYING = false
    getgenv().BUYING_AMMO = false
    
    -- Re-equip guns after buying armor
    task.wait(0.1)
    pcall(AutoEquipGuns)
    
    -- Resume combat if it was paused
    if wasInCombat then
        task.delay(0.1, function()
            resumeCombatAfterBuying()
        end)
    -- Restart void if it was running before buying (and not resuming combat)
    elseif wasVoidEnabled then
        task.delay(0.2, function()
            if not getgenv().BUYING_LOCK and not isInCombat() then
                startVoid()
            end
        end)
    end
end

local function buyArmor()
    if not armorInfo then return end
    if not getgenv().Settings.AutoArmor.Mode then return end

    local armorValue = tonumber(armorInfo.Value) or 0
    local threshold = getgenv().Settings.AutoArmor.Threshold or 40

    if armorValue < threshold and canBuyArmor() and armorShop and armorClickDetector then
        teleportAndBuy(armorShop, armorClickDetector)
    end
end

local function checkArmor()
    while task.wait(0.5) do
        if getgenv().Settings.AutoArmor.Mode and armorInfo then
            buyArmor()
        end
    end
end

task.spawn(function()
    local ok, err = pcall(checkArmor)
    if not ok then
        warn("[AutoArmor] checkArmor error:", err)
    end
end)

local ffTimer = 0

local function checkFF(target)
    if not target or not target.Character then
        stopVoid()
        return
    end

    ffTimer += 0.05
    if ffTimer < 1 then return end
    ffTimer = 0

    local char = target.Character
    local hasFF = char:FindFirstChildOfClass("ForceField") ~= nil

    if hasFF then
        startVoid()
    else
        stopVoid()
    end
end

getgenv().Whitelist = getgenv().Whitelist or {}
getgenv().Teamed = getgenv().Teamed or {}

local LocalPlayer = game.Players.LocalPlayer

local function hasAccess(plr)
    return plr.Name == getgenv().Owner or table.find(getgenv().Whitelist, plr.Name)
end

-- Helper function to check if bot needs ammo
local function needsAmmoCheck()
    local gunsList = getgenv().Settings and getgenv().Settings.Guns and getgenv().Settings.Guns.List
    if not gunsList then return false end
    for _, gun in ipairs(gunsList) do
        local key = string.lower(string.gsub(gun, '%s+', ''))
        local gunName = gunMapping[key]
        if gunName then
            local currentAmmo = getAmmoFromInventory(gunName)
            if currentAmmo < 10 then
                return true
            end
        end
    end
    return false
end

-- Helper function to buy ammo quickly
local function quickBuyAmmo()
    local gunsList = getgenv().Settings and getgenv().Settings.Guns and getgenv().Settings.Guns.List
    if not gunsList then return end
    
    -- Buy ammo ONE AT A TIME, only for guns we have and need ammo for
    -- BuyItem will pause/resume combat as needed
    for _, gun in ipairs(gunsList) do
        local key = string.lower(string.gsub(gun, '%s+', ''))
        
        -- IMPORTANT: Can only buy ammo if we have the gun
        if not HasGunByName(key) then
            continue -- Skip ammo for guns we don't have
        end
        
        local gunName = gunMapping[key]
        if gunName then
            local currentAmmo = getAmmoFromInventory(gunName)
            -- Buy when ammo is 10 or lower, buy until 100 or more
            if currentAmmo <= 10 then
                local ammoName = ammoMapping[key]
                if ammoName then
                    -- Keep buying until we have 100+ ammo
                    while getAmmoFromInventory(gunName) < 100 do
                        BuyItem(ammoName, 1)
                        task.wait(0.3)
                    end
                end
            end
        end
    end
    
    -- Re-equip after all purchases
    task.wait(0.3)
    pcall(AutoEquipGuns)
end

-- Helper function to just equip guns (no buying - that happens in void)
local function ensureBotReady()
    pcall(AutoEquipGuns)
end

-- Helper function to clear a list
local function clearList(list)
    if type(list) ~= "table" then return end
    for i = #list, 1, -1 do list[i] = nil end
end

-- Function to stop all combat actions
local function hardStopAll()
    killAuraEnabled = false
    _G.AuraStop = true
    getgenv().grabbedOnce = true
    getgenv().FORCED_TARGETS = {}
    getgenv().LOOP_KILL_ACTIVE = false
    getgenv().LOOP_STOMP_KILL_ACTIVE = false
    getgenv().KA_ACTIVE = false
    getgenv().KA_SPEAKER = nil
    getgenv().NO_RELOAD = false
    getgenv().NO_RELOAD_STOMP = false
    getgenv().NO_RELOAD_GRAB = false
    getgenv().NO_RELOAD_BUYING = false
    getgenv().ABOUT_TO_STOMP = false
    getgenv().ABOUT_TO_GRAB = false
    getgenv().CURRENT_LOOP_TARGETS = {}
    getgenv().CURRENT_LOOP_CMD = nil

    pcall(function() clearList(auraTargets) end)
    pcall(function() clearList(targets) end)

    target = nil
    currentTarget = nil
    currentIndex = nil

    if auraLoopConnection and auraLoopConnection.Disconnect then
        pcall(function() auraLoopConnection:Disconnect() end)
        auraLoopConnection = nil
    end

    if orbitConnection and orbitConnection.Disconnect then
        pcall(function() orbitConnection:Disconnect() end)
        orbitConnection = nil
    end

    pcall(stopOrbit)
    auraTargets = {}
    targets = {}
end

-- Resume loop attacks after bot respawns
LocalPlayer.CharacterAdded:Connect(function(char)
    task.wait(2) -- Wait for respawn
    
    -- Just equip guns after respawn
    pcall(AutoEquipGuns)
end)

local function handleCommand(plr, msg)
    if not msg then return end
    if not hasAccess(plr) then return end

    local prefix = getgenv().Settings.Prefix or '.'
    local msgTrimmed = msg:gsub("^%s+", ""):gsub("%s+$", "")
    
    -- Check if message starts with prefix
    if msgTrimmed:sub(1, #prefix):lower() ~= prefix:lower() then return end
    
    -- Remove prefix from message
    local msgWithoutPrefix = msgTrimmed:sub(#prefix + 1):lower()
    local msgOrigWithoutPrefix = msgTrimmed:sub(#prefix + 1)
    
    local args = {}
    for word in msgWithoutPrefix:gmatch("%S+") do
        table.insert(args, word)
    end
    if #args == 0 then return end
    local cmd = args[1]
    
    -- Check if player is owner (for owner-only commands)
    local isOwner = (plr.Name == tostring(getgenv().Owner))
    
    -- OWNER ONLY COMMANDS: wl, unwl, t, unt, list, sentry, unsentry, re, rej
    local ownerOnlyCommands = {
        ["wl"] = true, ["unwl"] = true, ["t"] = true, ["unt"] = true, 
        ["list"] = true, ["sentry"] = true, ["unsentry"] = true, 
        ["re"] = true, ["rej"] = true
    }
    
    if ownerOnlyCommands[cmd] and not isOwner then
        return -- Whitelisted cannot use these commands
    end

    -- whitelist (OWNER ONLY)
    if cmd == "wl" and args[2] then
        local t = findPlayerByNameOrPartial(args[2])
        if t then
            if not table.find(getgenv().Whitelist, t.Name) then
                table.insert(getgenv().Whitelist, t.Name)
                sendChat("+ Added To Whitelist: "..t.Name)
            else
                sendChat(t.Name.." is already whitelisted.")
            end
        else
            sendChat("Could not find player: "..args[2])
        end
        return
    end

    -- unwhitelist
    if cmd == "unwl" and args[2] then
        local t = findPlayerByNameOrPartial(args[2])
        if t and table.find(getgenv().Whitelist, t.Name) then
            for i, name in ipairs(getgenv().Whitelist) do
                if name == t.Name then
                    table.remove(getgenv().Whitelist, i)
                    sendChat("- Removed From Whitelist: "..t.Name)
                    break
                end
            end
        else
            sendChat(t and (t.Name.." is not in whitelist.") or ("Could not find player: "..args[2]))
        end
        return
    end

    -- team a player (protected + sentry protection)
    if cmd == "t" and args[2] then
        local t = findPlayerByNameOrPartial(args[2])
        if t then
            if not table.find(getgenv().Teamed, t.Name) then
                table.insert(getgenv().Teamed, t.Name)
                sendChat("+ Teamed: "..t.Name.." (Protected)")
            else
                sendChat(t.Name.." is already teamed.")
            end
        else
            sendChat("Could not find player: "..args[2])
        end
        return
    end

    -- unteam a player
    if cmd == "unt" and args[2] then
        local t = findPlayerByNameOrPartial(args[2])
        if t and table.find(getgenv().Teamed, t.Name) then
            for i, name in ipairs(getgenv().Teamed) do
                if name == t.Name then
                    table.remove(getgenv().Teamed, i)
                    sendChat("- Unteamed: "..t.Name)
                    break
                end
            end
        else
            sendChat(t and (t.Name.." is not teamed.") or ("Could not find player: "..args[2]))
        end
        return
    end

    -- list whitelisted and teamed players
    if cmd == "list" then
        local wlList = #getgenv().Whitelist > 0 and table.concat(getgenv().Whitelist, ", ") or "None"
        local teamList = #getgenv().Teamed > 0 and table.concat(getgenv().Teamed, ", ") or "None"
        sendChat("WL: " .. wlList)
        task.wait(0.5)
        sendChat("Teamed: " .. teamList)
        return
    end

    -- follow/summon
    if cmd == "f" then
        stopVoid()
        teleportTo(plr)
        startAutoEquipGuns()
        pcall(AutoEquipGuns)
        return
    end

    -- void
    if cmd == "v" then
        vanishBot()
        return
    end

-- kill aura - kills anyone within 200 studs of the speaker
if cmd == "ka" then
    local speaker = plr
    if not (speaker and speaker.Character and speaker.Character:FindFirstChild("HumanoidRootPart")) then
        sendChat("Speaker invalid or not spawned.")
        return
    end

    getgenv().KA_ACTIVE = true
    getgenv().KA_SPEAKER = speaker
    getgenv().AURA_STOP = false
    getgenv().AURA_FORCE_DISABLE = false
    stopVoid()

    sendChat("Kill Aura ON - Protecting " .. speaker.Name)

    task.spawn(function()
        local LP = LocalPlayer or game.Players.LocalPlayer

        while getgenv().KA_ACTIVE do
            task.wait(0.1)

            -- Check if bot character exists
            local myChar = LP and LP.Character
            local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")
            if not myHRP then 
                stopOrbit()
                killAuraEnabled = false
                task.wait(0.5)
                continue 
            end

            -- Check if speaker still valid
            local speakerChar = speaker and speaker.Character
            local speakerHRP = speakerChar and speakerChar:FindFirstChild("HumanoidRootPart")
            if not speakerHRP then
                task.wait(0.5)
                continue
            end

            -- Ensure bot has guns
            ensureBotReady()

            -- Find all enemies within 200 studs of the speaker
            local targets = {}
            for _, enemy in ipairs(Players:GetPlayers()) do
                if enemy == LP then continue end
                if enemy == speaker then continue end
                if isProtectedPlayer(enemy.Name) then continue end

                local enemyChar = enemy.Character
                if not enemyChar then continue end

                local enemyHRP = enemyChar:FindFirstChild("HumanoidRootPart")
                if not enemyHRP then continue end

                -- Check distance from SPEAKER (not bot)
                local distance = (speakerHRP.Position - enemyHRP.Position).Magnitude
                if distance > 200 then continue end

                local be = enemyChar:FindFirstChild("BodyEffects")
                local isKO = be and be:FindFirstChild("K.O") and be["K.O"].Value
                local isSDeath = be and be:FindFirstChild("SDeath") and be["SDeath"].Value
                local hasFF = enemyChar:FindFirstChildOfClass("ForceField") ~= nil

                if not isKO and not isSDeath and not hasFF then
                    table.insert(targets, enemy)
                end
            end

            if #targets > 0 then
                stopVoid()
                
                -- Attack all targets
                auraTargets = targets
                killAuraEnabled = true
                startAutoEquipGuns()

                -- Orbit closest target to speaker
                local closestTarget = nil
                local closestDist = math.huge
                for _, t in ipairs(targets) do
                    local tHRP = t.Character and t.Character:FindFirstChild("HumanoidRootPart")
                    if tHRP then
                        local dist = (speakerHRP.Position - tHRP.Position).Magnitude
                        if dist < closestDist then
                            closestDist = dist
                            closestTarget = t
                        end
                    end
                end

                if closestTarget and getgenv().orbitTarget ~= closestTarget then
                    stopOrbit()
                    startOrbit(closestTarget)
                end
            else
                -- No targets, go to void
                stopOrbit()
                killAuraEnabled = false
                auraTargets = {}
                startVoid()
            end
        end

        getgenv().KA_SPEAKER = nil
        hardStopAll()
        killAuraEnabled = false
        auraTargets = {}
        stopOrbit()
        vanishBot()
    end)

    return
end

-- kill
if cmd == "k" and args[2] then
getgenv().AURA_STOP = false
getgenv().AURA_FORCE_DISABLE = false
getgenv().FORCED_TARGETS = {}
    stopVoid()

    local rest = msgOrigWithoutPrefix:sub(#args[1] + 2)
    local targetNames = {}
    for name in rest:gmatch("[^,%s]+") do
        table.insert(targetNames, name)
    end

    task.spawn(function()

        local LP = LocalPlayer or game.Players.LocalPlayer

        local targets = {}
        for _, name in ipairs(targetNames) do
            local pl = findPlayerByNameOrPartial(name)
            if pl then
                if canCommandAttack(pl, plr) then
                    table.insert(targets, pl)
                    -- Add to forced targets so aura will attack them
                    table.insert(getgenv().FORCED_TARGETS, pl.Name)
                else
                    sendChat("Protected: " .. pl.Name)
                end
            end
        end
        if #targets == 0 then
            sendChat("Invalid target/s")
            return
        end

        -- Ensure bot is ready
        ensureBotReady()

        local aliveTargets = {}
        for _, t in ipairs(targets) do
            local char = t.Character
            local be = char and char:FindFirstChild("BodyEffects")
            local isKO = be and be:FindFirstChild("K.O") and be["K.O"].Value
            if char and char:FindFirstChild("HumanoidRootPart") and not isKO then
                table.insert(aliveTargets, t)
            end
        end

        if #aliveTargets == 0 then
            stopOrbit()
            killAuraEnabled = false
            auraTargets = {}
            vanishBot()
            return
        end

        auraTargets = {}
        for _, t in ipairs(aliveTargets) do
            table.insert(auraTargets, t)
        end

        startAutoEquipGuns()
        killAuraEnabled = true
        local currentIndex = 1

        local function startOnTarget(idx)
            local tgt = aliveTargets[idx]
            if tgt and tgt.Character and tgt.Character:FindFirstChild("HumanoidRootPart") then
                startOrbit(tgt)
                task.wait(0.08)
                killAuraEnabled = true
            end
        end

        startOnTarget(currentIndex)

        while #aliveTargets > 0 do
            task.wait(0.05)

            local LocalChar = LP and LP.Character
            if not LocalChar or not LocalChar:FindFirstChild("HumanoidRootPart") then
                -- Bot died, wait for respawn
                stopOrbit()
                killAuraEnabled = false
                task.wait(0.5)
                continue
            end
            
            -- Just make sure guns are equipped
            pcall(AutoEquipGuns)

            local curTarget = aliveTargets[currentIndex]
            if not curTarget or not curTarget.Character then
                table.remove(aliveTargets, currentIndex)

                if currentIndex > #aliveTargets then currentIndex = 1 end
                if #aliveTargets > 0 then startOnTarget(currentIndex) end
                continue
            end

            local char = curTarget.Character
            local be = char:FindFirstChild("BodyEffects")
            local hrp = char:FindFirstChild("HumanoidRootPart")
            local isKO = be and be:FindFirstChild("K.O") and be["K.O"].Value
            local isSDeath = be and be:FindFirstChild("SDeath") and be["SDeath"].Value

            if not hrp or isKO or isSDeath then
                table.remove(aliveTargets, currentIndex)

                if #aliveTargets == 0 then
                    stopOrbit()
                    killAuraEnabled = false
                    auraTargets = {}
                    vanishBot()
                    break
                else
                    if currentIndex > #aliveTargets then currentIndex = 1 end
                    startOnTarget(currentIndex)
                    continue
                end
            end

            checkFF(curTarget)

            local orbitTarget = getgenv().orbitTarget
            if not orbitTarget or orbitTarget ~= curTarget then
                startOrbit(curTarget)
                killAuraEnabled = true
            end
        end

        hardStopAll()
        killAuraEnabled = false
        auraTargets = {}
        stopOrbit()
        vanishBot()
    end)

    return
end

-- loop kill (keeps killing after respawn)
if cmd == "lk" and args[2] then
getgenv().AURA_STOP = false
getgenv().AURA_FORCE_DISABLE = false
getgenv().LOOP_KILL_ACTIVE = true
getgenv().FORCED_TARGETS = {}
getgenv().CURRENT_LOOP_TARGETS = {}
getgenv().CURRENT_LOOP_CMD = "lk"
    stopVoid()

    local rest = msgOrigWithoutPrefix:sub(#args[1] + 2)
    local targetNames = {}
    for name in rest:gmatch("[^,%s]+") do
        table.insert(targetNames, name)
    end

    task.spawn(function()
        local LP = LocalPlayer or game.Players.LocalPlayer

        local targets = {}
        for _, name in ipairs(targetNames) do
            local pl = findPlayerByNameOrPartial(name)
            if pl then
                if canCommandAttack(pl, plr) then
                    table.insert(targets, pl)
                    table.insert(getgenv().FORCED_TARGETS, pl.Name)
                    table.insert(getgenv().CURRENT_LOOP_TARGETS, pl)
                else
                    sendChat("Protected: " .. pl.Name)
                end
            end
        end
        if #targets == 0 then
            sendChat("Invalid target/s")
            return
        end

        sendChat("Loop killing: " .. #targets .. " target(s)")

        while getgenv().LOOP_KILL_ACTIVE do
            -- Check if bot character exists, if not wait for respawn
            if not LP.Character or not LP.Character:FindFirstChild("HumanoidRootPart") then
                task.wait(0.5)
                continue
            end
            
            -- Ensure bot has guns and ammo before each loop iteration
            ensureBotReady()

            -- Process all targets
            for _, target in ipairs(targets) do
                if not getgenv().LOOP_KILL_ACTIVE then break end
                if not target then continue end

                -- Wait for target to have character - GO TO VOID while waiting
                if not target.Character then
                    startVoid()
                    task.wait(0.5)
                    continue
                end

                local char = target.Character
                local be = char:FindFirstChild("BodyEffects")
                local hrp = char:FindFirstChild("HumanoidRootPart")

                if not hrp or not be then 
                    startVoid()
                    task.wait(0.3)
                    continue 
                end

                local isKO = be:FindFirstChild("K.O") and be["K.O"].Value
                local isSDeath = be:FindFirstChild("SDeath") and be["SDeath"].Value
                local hasFF = char:FindFirstChildOfClass("ForceField") ~= nil

                -- If has forcefield, go to void
                if hasFF then
                    stopOrbit()
                    killAuraEnabled = false
                    startVoid()
                    task.wait(0.5)
                    continue
                end

                -- If already KO or dead, go to void and wait for respawn
                if isKO or isSDeath then
                    stopOrbit()
                    killAuraEnabled = false
                    startVoid()
                    task.wait(0.5)
                    continue
                end

                -- Attack this target
                stopVoid()
                auraTargets = { target }
                killAuraEnabled = true
                startAutoEquipGuns()
                startOrbit(target)

                -- Keep attacking until KO or dead
                while getgenv().LOOP_KILL_ACTIVE do
                    task.wait(0.05)
                    
                    -- Check if bot died
                    if not LP.Character or not LP.Character:FindFirstChild("HumanoidRootPart") then
                        stopOrbit()
                        killAuraEnabled = false
                        break
                    end
                    
                    local c = target.Character
                    if not c then break end
                    local b = c:FindFirstChild("BodyEffects")
                    if not b then break end
                    local ko = b:FindFirstChild("K.O") and b["K.O"].Value
                    local sd = b:FindFirstChild("SDeath") and b["SDeath"].Value
                    if ko or sd then break end
                end

                stopOrbit()
                killAuraEnabled = false
                auraTargets = {}
                
                -- Go to VOID after killing, wait for respawn
                startVoid()
            end

            task.wait(0.5)
        end

        getgenv().CURRENT_LOOP_TARGETS = {}
        getgenv().CURRENT_LOOP_CMD = nil
        hardStopAll()
        killAuraEnabled = false
        auraTargets = {}
        stopOrbit()
        vanishBot()
    end)

    return
end

-- LOOP STOMP KILL - Stomps player, waits for respawn, repeats
if cmd == "lsk" and args[2] then
    getgenv().AURA_STOP = false
    getgenv().AURA_FORCE_DISABLE = false
    getgenv().LOOP_STOMP_KILL_ACTIVE = true
    getgenv().FORCED_TARGETS = {}
    getgenv().CURRENT_LOOP_TARGETS = {}
    getgenv().CURRENT_LOOP_CMD = "lsk"
    stopVoid()

    local rest = msgOrigWithoutPrefix:sub(#args[1] + 2)
    local targetNames = {}
    for name in rest:gmatch("[^,%s]+") do
        table.insert(targetNames, name)
    end

    task.spawn(function()
        local LP = LocalPlayer or game.Players.LocalPlayer

        local targets = {}
        for _, name in ipairs(targetNames) do
            local pl = findPlayerByNameOrPartial(name)
            if pl then
                if canCommandAttack(pl, plr) then
                    table.insert(targets, pl)
                    table.insert(getgenv().FORCED_TARGETS, pl.Name)
                    table.insert(getgenv().CURRENT_LOOP_TARGETS, pl)
                else
                    sendChat("Protected: " .. pl.Name)
                end
            end
        end
        if #targets == 0 then
            sendChat("Invalid target/s")
            return
        end

        sendChat("Loop Stomp Killing: " .. #targets .. " target(s)")

        while getgenv().LOOP_STOMP_KILL_ACTIVE do
            -- Check if bot character exists, if not wait for respawn
            if not LP.Character or not LP.Character:FindFirstChild("HumanoidRootPart") then
                task.wait(0.5)
                continue
            end
            
            -- Ensure bot has guns and ammo before each loop iteration
            ensureBotReady()

            -- Process all targets
            for _, target in ipairs(targets) do
                if not getgenv().LOOP_STOMP_KILL_ACTIVE then break end
                if not target then continue end

                -- Wait for target to have character - GO TO VOID while waiting
                if not target.Character then
                    startVoid()
                    task.wait(0.5)
                    continue
                end

                local char = target.Character
                local be = char:FindFirstChild("BodyEffects")
                local hrp = char:FindFirstChild("HumanoidRootPart")

                if not hrp or not be then 
                    startVoid()
                    task.wait(0.5)
                    continue 
                end

                local isKO = be:FindFirstChild("K.O") and be["K.O"].Value
                local isSDeath = be:FindFirstChild("SDeath") and be["SDeath"].Value
                local hasFF = char:FindFirstChildOfClass("ForceField") ~= nil

                -- If has forcefield, go to void
                if hasFF then
                    stopOrbit()
                    killAuraEnabled = false
                    startVoid()
                    task.wait(0.5)
                    continue
                end

                -- Phase 1: Kill the target until KO
                if not isKO and not isSDeath then
                    stopVoid()
                    auraTargets = { target }
                    killAuraEnabled = true
                    startAutoEquipGuns()
                    startOrbit(target)

                    -- Wait until target is KO'd
                    while getgenv().LOOP_STOMP_KILL_ACTIVE do
                        task.wait(0.05)
                        
                        -- Check if bot died
                        if not LP.Character or not LP.Character:FindFirstChild("HumanoidRootPart") then
                            stopOrbit()
                            killAuraEnabled = false
                            break
                        end
                        
                        local c = target.Character
                        if not c then break end
                        local b = c:FindFirstChild("BodyEffects")
                        if not b then break end
                        local ko = b:FindFirstChild("K.O") and b["K.O"].Value
                        if ko then break end
                    end

                    stopOrbit()
                    killAuraEnabled = false
                    auraTargets = {}
                end

                -- Phase 2: Stomp the target (NO RELOAD during stomp)
                -- STOP ALL RELOAD before stomping
                getgenv().NO_RELOAD = true
                getgenv().NO_RELOAD_STOMP = true
                getgenv().ABOUT_TO_STOMP = true
                
                -- Keep trying to stomp until successful or target dies/respawns
                local stompAttempts = 0
                local maxStompAttempts = 20
                
                while stompAttempts < maxStompAttempts and getgenv().LOOP_STOMP_KILL_ACTIVE do
                    stompAttempts = stompAttempts + 1
                    
                    local refreshedChar = target.Character
                    if not refreshedChar then break end
                    if not LP.Character or not LP.Character:FindFirstChild("HumanoidRootPart") then break end
                    
                    local refreshedBE = refreshedChar:FindFirstChild("BodyEffects")
                    if not refreshedBE then break end
                    
                    local refreshedKO = refreshedBE:FindFirstChild("K.O") and refreshedBE["K.O"].Value
                    local refreshedSDeath = refreshedBE:FindFirstChild("SDeath") and refreshedBE["SDeath"].Value
                    
                    -- Stop if target died (stomp worked)
                    if refreshedSDeath then break end
                    
                    -- Only stomp if KO
                    if refreshedKO then
                        local upperTorso = refreshedChar:FindFirstChild("UpperTorso") or refreshedChar:FindFirstChild("Torso")
                        if upperTorso then
                            -- Teleport on top multiple times to ensure position
                            for teleportAttempt = 1, 3 do
                                LP.Character.HumanoidRootPart.CFrame = CFrame.new(upperTorso.Position + Vector3.new(0, 3, 0))
                                LP.Character.HumanoidRootPart.AssemblyLinearVelocity = Vector3.zero
                                task.wait()
                            end
                            
                            -- Fire stomp
                            pcall(function()
                                MainEvent:FireServer("Stomp")
                            end)
                            task.wait(0.15)
                        end
                    else
                        -- Not KO anymore, break
                        break
                    end
                    
                    task.wait(0.1)
                end
                
                getgenv().NO_RELOAD = false
                getgenv().NO_RELOAD_STOMP = false
                getgenv().ABOUT_TO_STOMP = false

                -- Phase 3: Go to VOID while waiting for target to respawn
                startVoid()
                
                local waitStart = tick()
                local maxWait = 15 -- Max 15 seconds to wait for respawn

                while getgenv().LOOP_STOMP_KILL_ACTIVE and (tick() - waitStart) < maxWait do
                    task.wait(0.3)

                    local newChar = target.Character
                    if not newChar then continue end

                    local newBE = newChar:FindFirstChild("BodyEffects")
                    if not newBE then continue end

                    local newKO = newBE:FindFirstChild("K.O") and newBE["K.O"].Value
                    local newSDeath = newBE:FindFirstChild("SDeath") and newBE["SDeath"].Value
                    local newFF = newChar:FindFirstChildOfClass("ForceField") ~= nil
                    local newHRP = newChar:FindFirstChild("HumanoidRootPart")

                    -- Target has respawned and is alive (no FF, not KO, not dead)
                    if newHRP and not newKO and not newSDeath and not newFF then
                        stopVoid()
                        break
                    end
                end
            end

            task.wait(0.3)
        end

        getgenv().CURRENT_LOOP_TARGETS = {}
        getgenv().CURRENT_LOOP_CMD = nil
        hardStopAll()
        killAuraEnabled = false
        auraTargets = {}
        stopOrbit()
        vanishBot()
    end)

    return
end

-- stomp kill
if cmd == "sk" and args[2] then
getgenv().AURA_STOP = false
getgenv().AURA_FORCE_DISABLE = false
getgenv().FORCED_TARGETS = {}
    stopVoid()
    
    local rest = msgOrigWithoutPrefix:sub(#args[1] + 2)
    local targetNames = {}

    for name in rest:gmatch("[^,%s]+") do
        table.insert(targetNames, name)
    end

    task.spawn(function()
        local LP = LocalPlayer or game.Players.LocalPlayer

        local targets = {}
        for _, targetName in ipairs(targetNames) do
            local pl = findPlayerByNameOrPartial(targetName)
            if pl then
                if canCommandAttack(pl, plr) then
                    table.insert(targets, pl)
                    table.insert(getgenv().FORCED_TARGETS, pl.Name)
                else
                    sendChat("Protected: " .. pl.Name)
                end
            end
        end
        if #targets == 0 then
            sendChat("Invalid target/s")
            return
        end

        auraTargets = {}
        for _, t in ipairs(targets) do
            table.insert(auraTargets, t)
        end

        startAutoEquipGuns()
        pcall(AutoEquipGuns)
        killAuraEnabled = true

        local currentIndex = 1

        local function getNextValidTarget()
            for i = 1, #targets do
                local t = targets[i]
                if t and t.Character and t.Character:FindFirstChild("HumanoidRootPart") then
                    local be = t.Character:FindFirstChild("BodyEffects")
                    if be then
                        local sdeath = be:FindFirstChild("SDeath") and be.SDeath.Value
                        if not sdeath then
                            return t, i
                        end
                    end
                end
            end
            return nil, nil
        end

        local function startOnTarget(tgt)
            if tgt and tgt.Character and tgt.Character:FindFirstChild("HumanoidRootPart") then
                startOrbit(tgt)
            end
        end

        local target, idx = getNextValidTarget()
        if not target then
            stopOrbit()
            killAuraEnabled = false
            auraTargets = {}
            vanishBot()
            return
        end
        currentIndex = idx

        startOnTarget(target)

        while #targets > 0 do
            task.wait(0.05)
            
            -- Check if bot died
            if not LP.Character or not LP.Character:FindFirstChild("HumanoidRootPart") then
                stopOrbit()
                killAuraEnabled = false
                task.wait(0.5)
                continue
            end
            
            -- Just make sure guns are equipped
            pcall(AutoEquipGuns)

            target = targets[currentIndex]

            if not target or not target.Character then
                table.remove(targets, currentIndex)
                target, idx = getNextValidTarget()
                if not target then break end
                currentIndex = idx
                startOnTarget(target)
                continue
            end

            local bodyEffects = target.Character:FindFirstChild("BodyEffects")
            local hrp = target.Character:FindFirstChild("HumanoidRootPart")
            if not hrp or not bodyEffects then
                table.remove(targets, currentIndex)
                target, idx = getNextValidTarget()
                if not target then break end
                currentIndex = idx
                startOnTarget(target)
                continue
            end

            local isKO = bodyEffects:FindFirstChild("K.O") and bodyEffects["K.O"].Value
            local isSDeath = bodyEffects:FindFirstChild("SDeath") and bodyEffects["SDeath"].Value

            checkFF(target)

            if isKO and not isSDeath then
                stopOrbit()
                killAuraEnabled = false
                
                -- STOP ALL RELOAD before stomping
                getgenv().NO_RELOAD = true
                getgenv().NO_RELOAD_STOMP = true
                getgenv().ABOUT_TO_STOMP = true
                task.wait(0.15)

                local refreshedChar = target.Character
                if refreshedChar and LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
                    local upperTorso = refreshedChar:FindFirstChild("UpperTorso") or refreshedChar:FindFirstChild("Torso")
                    if upperTorso then
                        LP.Character.HumanoidRootPart.CFrame =
                            CFrame.new(upperTorso.Position + Vector3.new(0,3,0))
                        
                        task.wait(0.05)
                        pcall(function()
                            MainEvent:FireServer("Stomp")
                        end)
                        task.wait(0.5)
                    end
                end
                
                getgenv().NO_RELOAD = false
                getgenv().NO_RELOAD_STOMP = false
                getgenv().ABOUT_TO_STOMP = false
            end

            if isSDeath then
                table.remove(targets, currentIndex)
                target, idx = getNextValidTarget()

                if target then
                    currentIndex = idx
                    startOnTarget(target)
                    killAuraEnabled = true
                else
                    stopOrbit()
                    killAuraEnabled = false
                    auraTargets = {}
                    vanishBot()
                    break
                end
            end
        end
        
        hardStopAll()
        vanishBot()
    end)

    return
end

-- bring
if cmd == "b" and args[2] then
getgenv().AURA_STOP = false
getgenv().AURA_FORCE_DISABLE = false
getgenv().FORCED_TARGETS = {}
    stopVoid()
    
    local rest = msgOrigWithoutPrefix:sub(#args[1] + 2)
    local targetNames = {}

    for name in rest:gmatch("[^,%s]+") do
        table.insert(targetNames, name)
    end

    task.spawn(function()
        local LP = LocalPlayer or game.Players.LocalPlayer

        targets = {}
        for _, targetName in ipairs(targetNames) do
            local pl = findPlayerByNameOrPartial(targetName)
            if pl then
                if canCommandAttack(pl, plr) then
                    table.insert(targets, pl)
                    table.insert(getgenv().FORCED_TARGETS, pl.Name)
                else
                    sendChat("Protected: " .. pl.Name)
                end
            end
        end
        if #targets == 0 then
            sendChat("Invalid target/s")
            return
        end

        -- Ensure bot is ready
        ensureBotReady()

        auraTargets = {}
        for _, t in ipairs(targets) do
            table.insert(auraTargets, t)
        end

        startAutoEquipGuns()
        killAuraEnabled = true

        local currentIndex = 1

        local function getNextValidTarget()
            for i = 1, #targets do
                local t = targets[i]
                if t and t.Character and t.Character:FindFirstChild("HumanoidRootPart") then
                    local be = t.Character:FindFirstChild("BodyEffects")
                    if be then
                        local sdeath = be:FindFirstChild("SDeath") and be.SDeath.Value
                        if not sdeath then
                            return t, i
                        end
                    end
                end
            end
            return nil, nil
        end

        local function startOnTarget(tgt)
            if tgt and tgt.Character and tgt.Character:FindFirstChild("HumanoidRootPart") then
                startOrbit(tgt)
            end
        end

        local target, idx = getNextValidTarget()
        if not target then
            stopOrbit()
            killAuraEnabled = false
            auraTargets = {}
            vanishBot()
            return
        end
        currentIndex = idx

        startOnTarget(target)

        while #targets > 0 do
            task.wait(0.05)
            
            -- Check if bot died
            if not LP.Character or not LP.Character:FindFirstChild("HumanoidRootPart") then
                stopOrbit()
                killAuraEnabled = false
                task.wait(0.5)
                continue
            end
            
            -- Just make sure guns are equipped
            pcall(AutoEquipGuns)

            target = targets[currentIndex]

            if not target or not target.Character then
                table.remove(targets, currentIndex)
                target, idx = getNextValidTarget()
                if not target then break end
                currentIndex = idx
                startOnTarget(target)
                continue
            end

            local bodyEffects = target.Character:FindFirstChild("BodyEffects")
            local hrp = target.Character:FindFirstChild("HumanoidRootPart")
            if not hrp or not bodyEffects then
                table.remove(targets, currentIndex)
                target, idx = getNextValidTarget()
                if not target then break end
                currentIndex = idx
                startOnTarget(target)
                continue
            end

            local isKO = bodyEffects:FindFirstChild("K.O") and bodyEffects["K.O"].Value
            local isSDeath = bodyEffects:FindFirstChild("SDeath") and bodyEffects["SDeath"].Value

            checkFF(target)

            if isKO and not isSDeath then
                killAuraEnabled = false
                stopOrbit()
                
                -- STOP ALL RELOAD before grabbing
                getgenv().NO_RELOAD = true
                getgenv().NO_RELOAD_GRAB = true
                getgenv().ABOUT_TO_GRAB = true
                task.wait(0.2)

                local tchar = target.Character
                local lpchar = LP and LP.Character
                if not tchar or not lpchar then
                    getgenv().NO_RELOAD = false
                    getgenv().NO_RELOAD_GRAB = false
                    getgenv().ABOUT_TO_GRAB = false
                    hardStopAll()
                    vanishBot()
                    return
                end

                local torso = tchar:FindFirstChild("UpperTorso") or tchar:FindFirstChild("Torso")
                if torso and lpchar:FindFirstChild("HumanoidRootPart") then
                    -- Teleport to target multiple times to ensure we're close
                    for i = 1, 3 do
                        lpchar.HumanoidRootPart.CFrame = CFrame.new(torso.Position + Vector3.new(0, 3, 0))
                        lpchar.HumanoidRootPart.AssemblyLinearVelocity = Vector3.zero
                        lpchar.HumanoidRootPart.AssemblyAngularVelocity = Vector3.zero
                        task.wait(0.05)
                    end
                    
                    -- Fire grab
                    pcall(function() MainEvent:FireServer("Grabbing") end)
                end

                -- Wait for grab with timeout
                local grabStart = tick()
                local maxGrabWait = 3
                local grabbed = false
                
                while tick() - grabStart < maxGrabWait do
                    task.wait(0.05)
                    if not target or not target.Character then break end
                    
                    -- Check for grab constraint on target
                    if target.Character:FindFirstChild("GRABBING_CONSTRAINT") then
                        grabbed = true
                        break
                    end
                    
                    -- Also check if bot has the constraint
                    local myChar = LP and LP.Character
                    if myChar and myChar:FindFirstChild("GRABBING_CONSTRAINT") then
                        grabbed = true
                        break
                    end
                    
                    -- Keep trying to grab if not grabbed yet
                    local tchar2 = target.Character
                    local lpchar2 = LP and LP.Character
                    if tchar2 and lpchar2 and lpchar2:FindFirstChild("HumanoidRootPart") then
                        local torso2 = tchar2:FindFirstChild("UpperTorso") or tchar2:FindFirstChild("Torso")
                        if torso2 then
                            lpchar2.HumanoidRootPart.CFrame = CFrame.new(torso2.Position + Vector3.new(0, 3, 0))
                            pcall(function() MainEvent:FireServer("Grabbing") end)
                        end
                    end
                end

                if not grabbed or not target or not target.Character then
                    getgenv().NO_RELOAD = false
                    getgenv().NO_RELOAD_GRAB = false
                    getgenv().ABOUT_TO_GRAB = false
                    vanishBot()
                    return
                end

                -- Small wait to ensure grab is stable
                task.wait(0.3)
                
                -- Teleport to owner
                pcall(function()
                    teleportTo(plr)
                end)

                -- Wait for arrival then drop
                task.wait(0.6)

                -- Release grab
                pcall(function()
                    MainEvent:FireServer("Grabbing")
                end)
                
                task.wait(0.1)

                getgenv().NO_RELOAD = false
                getgenv().NO_RELOAD_GRAB = false
                getgenv().ABOUT_TO_GRAB = false
                
                -- DONE - Exit the entire function
                hardStopAll()
                killAuraEnabled = false
                stopOrbit()
                vanishBot()
                return
            end

            if isSDeath then
                table.remove(targets, currentIndex)
                target, idx = getNextValidTarget()

                if target then
                    currentIndex = idx
                    startOnTarget(target)
                    killAuraEnabled = true
                else
                    stopOrbit()
                    killAuraEnabled = false
                    auraTargets = {}
                    vanishBot()
                    break
                end
            end
        end

        hardStopAll()
        vanishBot()
    end)

    return
end

-- SKY - Like bring but drops player 9999 studs in the air
if cmd == "sky" and args[2] then
    getgenv().AURA_STOP = false
    getgenv().AURA_FORCE_DISABLE = false
    getgenv().FORCED_TARGETS = {}
    stopVoid()
    
    local rest = msgOrigWithoutPrefix:sub(#args[1] + 2)
    local targetNames = {}

    for name in rest:gmatch("[^,%s]+") do
        table.insert(targetNames, name)
    end

    task.spawn(function()
        local LP = LocalPlayer or game.Players.LocalPlayer

        targets = {}
        for _, targetName in ipairs(targetNames) do
            local pl = findPlayerByNameOrPartial(targetName)
            if pl then
                if canCommandAttack(pl, plr) then
                    table.insert(targets, pl)
                    table.insert(getgenv().FORCED_TARGETS, pl.Name)
                else
                    sendChat("Protected: " .. pl.Name)
                end
            end
        end
        if #targets == 0 then
            sendChat("Invalid target/s")
            return
        end

        -- Ensure bot is ready
        ensureBotReady()

        auraTargets = {}
        for _, t in ipairs(targets) do
            table.insert(auraTargets, t)
        end

        startAutoEquipGuns()
        killAuraEnabled = true

        local currentIndex = 1

        local function getNextValidTarget()
            for i = 1, #targets do
                local t = targets[i]
                if t and t.Character and t.Character:FindFirstChild("HumanoidRootPart") then
                    local be = t.Character:FindFirstChild("BodyEffects")
                    if be then
                        local sdeath = be:FindFirstChild("SDeath") and be.SDeath.Value
                        if not sdeath then
                            return t, i
                        end
                    end
                end
            end
            return nil, nil
        end

        local function startOnTarget(tgt)
            if tgt and tgt.Character and tgt.Character:FindFirstChild("HumanoidRootPart") then
                startOrbit(tgt)
            end
        end

        local target, idx = getNextValidTarget()
        if not target then
            stopOrbit()
            killAuraEnabled = false
            auraTargets = {}
            vanishBot()
            return
        end
        currentIndex = idx

        startOnTarget(target)

        while #targets > 0 do
            task.wait(0.05)
            
            -- Check if bot died
            if not LP.Character or not LP.Character:FindFirstChild("HumanoidRootPart") then
                stopOrbit()
                killAuraEnabled = false
                task.wait(0.5)
                continue
            end
            
            pcall(AutoEquipGuns)

            target = targets[currentIndex]

            if not target or not target.Character then
                table.remove(targets, currentIndex)
                target, idx = getNextValidTarget()
                if not target then break end
                currentIndex = idx
                startOnTarget(target)
                continue
            end

            local bodyEffects = target.Character:FindFirstChild("BodyEffects")
            local hrp = target.Character:FindFirstChild("HumanoidRootPart")
            if not hrp or not bodyEffects then
                table.remove(targets, currentIndex)
                target, idx = getNextValidTarget()
                if not target then break end
                currentIndex = idx
                startOnTarget(target)
                continue
            end

            local isKO = bodyEffects:FindFirstChild("K.O") and bodyEffects["K.O"].Value
            local isSDeath = bodyEffects:FindFirstChild("SDeath") and bodyEffects["SDeath"].Value

            checkFF(target)

            if isKO and not isSDeath then
                killAuraEnabled = false
                stopOrbit()
                
                -- STOP ALL RELOAD before grabbing
                getgenv().NO_RELOAD = true
                getgenv().NO_RELOAD_GRAB = true
                getgenv().ABOUT_TO_GRAB = true
                task.wait(0.2)

                local tchar = target.Character
                local lpchar = LP and LP.Character
                if not tchar or not lpchar then
                    getgenv().NO_RELOAD = false
                    getgenv().NO_RELOAD_GRAB = false
                    getgenv().ABOUT_TO_GRAB = false
                    hardStopAll()
                    vanishBot()
                    return
                end

                local torso = tchar:FindFirstChild("UpperTorso") or tchar:FindFirstChild("Torso")
                if torso and lpchar:FindFirstChild("HumanoidRootPart") then
                    -- Teleport to target multiple times to ensure we're close
                    for i = 1, 3 do
                        lpchar.HumanoidRootPart.CFrame = CFrame.new(torso.Position + Vector3.new(0, 3, 0))
                        lpchar.HumanoidRootPart.AssemblyLinearVelocity = Vector3.zero
                        lpchar.HumanoidRootPart.AssemblyAngularVelocity = Vector3.zero
                        task.wait(0.05)
                    end
                    
                    -- Fire grab
                    pcall(function() MainEvent:FireServer("Grabbing") end)
                end

                -- Wait for grab with timeout
                local grabStart = tick()
                local maxGrabWait = 3
                local grabbed = false
                
                while tick() - grabStart < maxGrabWait do
                    task.wait(0.05)
                    if not target or not target.Character then break end
                    
                    if target.Character:FindFirstChild("GRABBING_CONSTRAINT") then
                        grabbed = true
                        break
                    end
                    
                    local myChar = LP and LP.Character
                    if myChar and myChar:FindFirstChild("GRABBING_CONSTRAINT") then
                        grabbed = true
                        break
                    end
                    
                    -- Keep trying to grab
                    local tchar2 = target.Character
                    local lpchar2 = LP and LP.Character
                    if tchar2 and lpchar2 and lpchar2:FindFirstChild("HumanoidRootPart") then
                        local torso2 = tchar2:FindFirstChild("UpperTorso") or tchar2:FindFirstChild("Torso")
                        if torso2 then
                            lpchar2.HumanoidRootPart.CFrame = CFrame.new(torso2.Position + Vector3.new(0, 3, 0))
                            pcall(function() MainEvent:FireServer("Grabbing") end)
                        end
                    end
                end

                if not grabbed or not target or not target.Character then
                    getgenv().NO_RELOAD = false
                    getgenv().NO_RELOAD_GRAB = false
                    getgenv().ABOUT_TO_GRAB = false
                    vanishBot()
                    return
                end

                -- Small wait to ensure grab is stable
                task.wait(0.3)
                
                -- TELEPORT TO SKY (9999 studs up)
                local lpchar3 = LP and LP.Character
                if lpchar3 and lpchar3:FindFirstChild("HumanoidRootPart") then
                    local currentPos = lpchar3.HumanoidRootPart.Position
                    local skyPos = Vector3.new(currentPos.X, 9999, currentPos.Z)
                    
                    -- Teleport to sky multiple times to ensure we get there
                    for i = 1, 5 do
                        lpchar3.HumanoidRootPart.CFrame = CFrame.new(skyPos)
                        lpchar3.HumanoidRootPart.AssemblyLinearVelocity = Vector3.zero
                        lpchar3.HumanoidRootPart.AssemblyAngularVelocity = Vector3.zero
                        task.wait(0.05)
                    end
                end

                -- Wait at sky height then drop
                task.wait(0.5)

                -- Release grab - they fall from 9999 studs
                pcall(function()
                    MainEvent:FireServer("Grabbing")
                end)
                
                task.wait(0.1)

                getgenv().NO_RELOAD = false
                getgenv().NO_RELOAD_GRAB = false
                getgenv().ABOUT_TO_GRAB = false
                
                -- DONE - Exit the entire function
                hardStopAll()
                killAuraEnabled = false
                stopOrbit()
                vanishBot()
                return
            end

            if isSDeath then
                table.remove(targets, currentIndex)
                target, idx = getNextValidTarget()

                if target then
                    currentIndex = idx
                    startOnTarget(target)
                    killAuraEnabled = true
                else
                    stopOrbit()
                    killAuraEnabled = false
                    auraTargets = {}
                    vanishBot()
                    break
                end
            end
        end

        hardStopAll()
        vanishBot()
    end)

    return
end

-- sentry protects owner + all whitelisted + teamed (uses bullet ray detection)
if cmd == "sentry" then
    if getgenv().SentryActive then
        sendChat("Sentry already active. Use .unsentry to stop.")
        return
    end

    getgenv().SentryActive = true
    getgenv().SentryReported = setmetatable({}, { __mode = "k" })
    sendChat("Sentry Enabled (owner + whitelisted + teamed)")

    local function isProtectedName(playerName)
        if playerName == tostring(getgenv().Owner) then return true end
        if table.find(getgenv().Whitelist, playerName) then return true end
        if table.find(getgenv().Teamed, playerName) then return true end
        return false
    end

    local function findPlayerFromInstance(inst)
        while inst do
            local pl = Players:GetPlayerFromCharacter(inst)
            if pl then return pl end
            inst = inst.Parent
        end
        return nil
    end

    local function findShooterFromBullet(bulletObj)
        if not bulletObj then return nil end
        for _, v in ipairs(bulletObj:GetChildren()) do
            if v:IsA("ObjectValue") or v:IsA("StringValue") then
                local name = v.Name:lower()
                if name:match("owner") or name:match("creator") or name:match("shooter") or name:match("player") then
                    local cand = v.Value
                    if typeof(cand) == "Instance" then
                        local p = Players:GetPlayerFromCharacter(cand)
                        if p then return p end
                        if cand:IsA("Player") then return cand end
                    elseif type(cand) == "string" then
                        local p = Players:FindFirstChild(cand)
                        if p then return p end
                    end
                end
            end
        end
        local anc = bulletObj.Parent
        while anc do
            local p = Players:GetPlayerFromCharacter(anc)
            if p then return p end
            anc = anc.Parent
        end
        local origin
        if bulletObj:IsA("BasePart") then
            origin = bulletObj.Position
        else
            local bp = bulletObj:FindFirstChildWhichIsA("BasePart") or bulletObj:FindFirstChildWhichIsA("Attachment")
            if bp then
                if bp:IsA("Attachment") then origin = bp.WorldPosition else origin = bp.Position end
            end
        end
        if origin then
            local bestPl, bestDist = nil, math.huge
            for _, p in ipairs(Players:GetPlayers()) do
                local c = p.Character
                if c then
                    local tool = c:FindFirstChildOfClass("Tool")
                    if tool and tool:FindFirstChild("Handle") then
                        local ok, pos = pcall(function() return tool.Handle.Position end)
                        if ok and pos then
                            local d = (pos - origin).Magnitude
                            if d < 12 and d < bestDist then bestPl, bestDist = p, d end
                        end
                    end
                    local hrp = c:FindFirstChild("HumanoidRootPart")
                    if hrp then
                        local d2 = (hrp.Position - origin).Magnitude
                        if d2 < 25 and d2 < bestDist then bestPl, bestDist = p, d2 end
                    end
                end
            end
            if bestPl then return bestPl end
        end
        return nil
    end

    local function getOriginAndDirection(bulletObj)
        if not bulletObj then return nil, nil end
        if bulletObj:IsA("BasePart") then
            local origin = bulletObj.Position
            local dir = (bulletObj.CFrame and bulletObj.CFrame.LookVector) and (bulletObj.CFrame.LookVector * 2000) or nil
            return origin, dir
        else
            local att = bulletObj:FindFirstChildWhichIsA("Attachment") or bulletObj:FindFirstChildWhichIsA("BasePart")
            if att then
                local origin = att:IsA("Attachment") and att.WorldPosition or att.Position
                local dir = (att.CFrame and att.CFrame.LookVector) and (att.CFrame.LookVector * 2000) or nil
                return origin, dir
            end
        end
        return nil, nil
    end

    local function victimFromTags(bulletObj)
        for _, v in ipairs(bulletObj:GetChildren()) do
            if v:IsA("ObjectValue") or v:IsA("StringValue") then
                local name = v.Name:lower()
                if name:match("victim") or name:match("target") or name:match("hit") then
                    local cand = v.Value
                    if typeof(cand) == "Instance" then
                        local p = Players:GetPlayerFromCharacter(cand)
                        if p then return p end
                        if cand:IsA("Player") then return cand end
                    elseif type(cand) == "string" then
                        local p = Players:FindFirstChild(cand)
                        if p then return p end
                    end
                end
            end
        end
        return nil
    end

    -- Setup bullet detection
    local ok, ignoredFolder = pcall(function() return workspace:WaitForChild("Ignored", 3) end)
    if not ok or not ignoredFolder then
        sendChat("Sentry failed - no Ignored folder")
        getgenv().SentryActive = false
        return
    end

    local ok2, siren = pcall(function() return ignoredFolder:WaitForChild("Siren", 3) end)
    if not ok2 or not siren then
        sendChat("Sentry failed - no Siren")
        getgenv().SentryActive = false
        return
    end

    local ok3, radiusFolder = pcall(function() return siren:WaitForChild("Radius", 3) end)
    if not ok3 or not radiusFolder then
        sendChat("Sentry failed - no Radius")
        getgenv().SentryActive = false
        return
    end

    getgenv().SentryConnection = radiusFolder.ChildAdded:Connect(function(obj)
        if not getgenv().SentryActive then return end
        if not obj or obj.Name ~= "BULLET_RAYS" then return end
        task.wait(0.02)

        if getgenv().SentryReported[obj] then return end
        getgenv().SentryReported[obj] = true

        local shooter = findShooterFromBullet(obj)
        if not shooter then return end
        if shooter == LocalPlayer then return end
        if isProtectedName(shooter.Name) then return end

        local origin, dir = getOriginAndDirection(obj)
        local victim = nil

        if origin and dir then
            local params = RaycastParams.new()
            params.FilterDescendantsInstances = { obj }
            params.FilterType = Enum.RaycastFilterType.Blacklist
            local okRay, res = pcall(function() return workspace:Raycast(origin, dir, params) end)
            if okRay and res and res.Instance then
                victim = findPlayerFromInstance(res.Instance)
            end
        end

        if not victim then
            victim = victimFromTags(obj)
        end

        -- If victim is protected (owner or whitelisted or teamed), attack the shooter
        if shooter and victim and shooter ~= victim and isProtectedName(victim.Name) then
            stopVoid()
            table.insert(getgenv().FORCED_TARGETS, shooter.Name)
            auraTargets = { shooter }
            startAutoEquipGuns()
            killAuraEnabled = true
            startOrbit(shooter)

            task.spawn(function()
                while getgenv().SentryActive and shooter and shooter.Character do
                    task.wait(0.05)
                    local be = shooter.Character:FindFirstChild("BodyEffects")
                    if be then
                        local isKO = be:FindFirstChild("K.O") and be["K.O"].Value
                        if isKO then
                            stopOrbit()
                            killAuraEnabled = false
                            auraTargets = {}
                            getgenv().FORCED_TARGETS = {}
                            vanishBot()
                            break
                        end
                    end
                end
            end)
        end
    end)

    return
end

getgenv().AURA_STOP = false
getgenv().AURA_FORCE_DISABLE = false

-- stop all combat
if cmd == "stop" then
    getgenv().AURA_STOP = true
    getgenv().AURA_FORCE_DISABLE = true
    getgenv().LOOP_KILL_ACTIVE = false
    getgenv().LOOP_STOMP_KILL_ACTIVE = false
    getgenv().KA_ACTIVE = false
    getgenv().KA_SPEAKER = nil
    getgenv().FORCED_TARGETS = {}
    getgenv().CURRENT_LOOP_TARGETS = {}
    getgenv().CURRENT_LOOP_CMD = nil
    getgenv().NO_RELOAD = false
    getgenv().NO_RELOAD_STOMP = false
    getgenv().NO_RELOAD_GRAB = false
    getgenv().NO_RELOAD_BUYING = false
    getgenv().ABOUT_TO_STOMP = false
    getgenv().ABOUT_TO_GRAB = false

    hardStopAll()
    stopOrbit()
    auraTargets = {}
    killAuraEnabled = false

    if getgenv().SentryActive then
        getgenv().SentryActive = false
        if getgenv().SentryConnection then
            pcall(function() getgenv().SentryConnection:Disconnect() end)
            getgenv().SentryConnection = nil
        end
    end

    if currentAuraTask then
        task.cancel(currentAuraTask)
        currentAuraTask = nil
    end

    startVoid()
    sendChat("Stopped")
    return
end

if cmd == "fix" then
    getgenv().AURA_STOP = true
    getgenv().AURA_FORCE_DISABLE = true
    getgenv().LOOP_KILL_ACTIVE = false
    getgenv().LOOP_STOMP_KILL_ACTIVE = false
    getgenv().KA_ACTIVE = false
    getgenv().KA_SPEAKER = nil
    getgenv().CURRENT_LOOP_TARGETS = {}
    getgenv().CURRENT_LOOP_CMD = nil
    getgenv().NO_RELOAD = false
    getgenv().NO_RELOAD_STOMP = false
    getgenv().NO_RELOAD_GRAB = false
    getgenv().NO_RELOAD_BUYING = false
    getgenv().ABOUT_TO_STOMP = false
    getgenv().ABOUT_TO_GRAB = false
    getgenv().BUYING_AMMO = false

    hardStopAll()
    stopOrbit()
    auraTargets = {}
    killAuraEnabled = false

    if currentAuraTask then
        task.cancel(currentAuraTask)
        currentAuraTask = nil
    end

    pcall(AutoEquipGuns)
    startVoid()
    return
end

if cmd == "unsentry" then
    if not getgenv().SentryActive then
        sendChat("Sentry not active.")
        return
    end
    getgenv().SentryActive = false

    if getgenv().SentryConnection then
        pcall(function()
            getgenv().SentryConnection:Disconnect()
        end)
        getgenv().SentryConnection = nil
    end

    killAuraEnabled = false
    stopOrbit()
    auraTargets = {}

    sendChat("Sentry disabled")
    return
end

    if cmd == "stopanim" then
        stopActivePose()
        return
    end

    local TeleportService = game:GetService("TeleportService")
local LocalPlayer = game.Players.LocalPlayer

if cmd == "rej" then
    TeleportService:Teleport(game.PlaceId, LocalPlayer)
    return
end

    if cmd == "re" then
        stopfakeposrespawn()
        return
    end

    if cmd == "yung" then
        stopActivePose()
        pcall(playDance, 15609995579)
        return
    end

    if cmd == "floss" then
        stopActivePose()
        pcall(playDance, 10714340543)
        return
    end
    
    if cmd == "samba" then
        stopActivePose()
        pcall(playDance, 10714386947)
        return
    end

    if cmd == "ro" then
        stopActivePose()
        pcall(playDance, 10714395175)
        return
    end

    if cmd == "to" then
        stopActivePose()
        pcall(playDance, 135373056067761)
        return
    end

    if cmd == "wo" then
        stopActivePose()
        pcall(playDance, 89593072932752)
        return
    end

    if cmd == "fd" then
        stopActivePose()
        pcall(playDance, 83403845306989)
        return
    end

    if cmd == "ga" then
        stopActivePose()
        pcall(playDance, 94928370656245)
        return
    end

    if cmd == "float" then
        stopActivePose()
        pcall(playDance, 115030690266962)
        return
    end

    if cmd == "griddy" then
        stopActivePose()
        pcall(playDance, 121966805049108)
        return
    end
end

local Players = game:GetService("Players")
local function hookChat()
    local function onChatted(plr)
        plr.Chatted:Connect(function(msg)
            pcall(function() handleCommand(plr, msg) end)
        end)
    end

    for _, plr in ipairs(Players:GetPlayers()) do
        onChatted(plr)
    end
    Players.PlayerAdded:Connect(onChatted)
end

hookChat()
print("")
print("   VoidStand v2 Loaded Successfully")
print("   Owner: " .. tostring(getgenv().Owner))
print("")

local Workspace = game:GetService("Workspace")
local TextChatService = game:GetService("TextChatService")
local StarterGui = game:GetService("StarterGui")

local function removeSeats()
    for _, seat in pairs(Workspace:GetDescendants()) do
        if seat:IsA("Seat") or seat:IsA("VehicleSeat") then
            seat:Destroy()
        end
    end
end

removeSeats()

local chatWindowConfig = TextChatService:FindFirstChild("ChatWindowConfiguration")
if chatWindowConfig then
    chatWindowConfig.Enabled = true
end

local chatInputConfig = TextChatService:FindFirstChild("ChatInputBarConfiguration")
if chatInputConfig then
    chatInputConfig.Enabled = true
end

pcall(function()
    StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.Chat, true)
end)

local originalHeight = workspace.FallenPartsDestroyHeight
workspace.FallenPartsDestroyHeight = -9999999999999999999999999

startAutoEquipGuns()
startVoid()
